/************************************************************************************************************/
/*                                                                                                          */
/*                                              MobileRobot.c                                               */
/*                                                                                                          */
/*                                                                                       2020. 1. 1.        */
/************************************************************************************************************/
#include "Interface.h"

// �ɼǿ���(��Ϲ���)	-> libraries -> liba.a & libm.a �߰�
// �ɼǿ���(��Ϲ���)	-> General -> Frequency 14745600 ����
// Interface.c 		 	-> Camera Baud Rate Setting : (USART1 Baud Rate: 115200)(��żӵ�)(UBRR1L=0x5F -> UBRR1L=0x07)
// Interface.c 			-> ISR Camera_V1 Setting
// Interface.c			-> lcd_clear_screen()�� cls()�� display_char()�� dc()��
// Interface.c 			-> Interface_init()�� putchar1(18); �߰� (ī�޶� V1 �������� ���)
// Motor.c 			 	-> SetGain 10, 3, 1 Setting
// Sensor.c				-> Sensor_init()�� DDRD  &= ~0x50; �߰�
// Sensor.h				-> READ_SENSOR()�� S�� ����
// Sensor.h				-> S�� | (~(PIND<<1)&0x20) | (~PIND&0x40) �߰�

char debug;

#define rev_stdir (-stdir)
#define rev_dir (!dir)
#define rev_num (9-num)
#define rev_ta (ta==135 ? 165:135)

int stdir, dir, num, ta;

void set(int mode){
	if(mode) stdir=1, dir=1, num=8, ta=135;
	else stdir=-1, dir=0, num=1, ta=165;
}

int T, G1, G1_gate, A;
// G1에 T값 저장

void attack3(int m){
	int tmp[3];
	if(m) V1(0,0,1,0,0,180,0,240,130,130,1);
	else V1(1,0,0,0,0,180,0,240,0,0,0);
	for(int i=0;i<3;i++) tmp[i]=C_D[i][0];
	for(int i=0;i<3;i++){
		if(tmp[i]==T){
			ping(3);
			V1(0,!!i,0,T,0,145,0,240,0,130,2);
			HM(-pw[3],500,11,70,0,0);
			HM(-pw[3],500,11,-70,0,0);
			LM(3,0,100,11,px[3],py[3],0,0);
		}
	}
}
void attack2(int m){
	int tmp[2];
	V1(1,0,0,0,0,180,0,240,0,0,0);
	for(int i=0;i<2;i++) tmp[i]=C_D[i][0];
	for(int i=0;i<2;i++){
		if(tmp[i]==T){
			if(m){
				ping(3);
				V1(0,i,0,0,0,180,0,240,130,130,3);
				HM(0,500,11,70,0,0);
				HM(0,500,11,-70,0,0);
				LM(3,300,100,11,0,0,0,0);
			}
			else{
				ping(3);
				V1(0,i,0,0,0,180,0,240,0,130,2);
				HM(-pw[3],500,11,100,0,0);
				HM(-pw[3],500,11,-100,0,0);
				LM(3,0,150,11,px[3],py[3],0,0); 
			}
		}
	}
}
void M1()
{
	HM(0,300,11,50,0,0);
	FCC(1,2,1,165);                            // 초기 위치 보정
	
	TD(0,400,11,250,0,92,0);                   // G1 회색 테이프로 이동
	FCC(2,2,0,0);                              // 뒷보정
	Pm(0,2,2,150,500,11,0,0,150,0,0);          // 
	G1_gate=FLine;
	Hm(180,400,11,0,0,1,4,200,0,0);
	FCC(1,2,1,165);

	LM(4,400,100,11,-50,150,-92,0);
	
	FCC(2,0,1,165);
	Pm(0,0,0,165,650,10,0,0,600,0,0);
	T=FLine;
	G1=G1_gate==T;  
	V1(11,0,0,0,0,180,0,240,0,0,0);
	Pm(0,0,0,165,650,00,0,0,50,0,0);
	if(C_D[0][0]==T){
		Pm(0,0,0,165,650,01,0,0,600,0,0);
		turn(1,100,11,20,0,0);
		FCC(2,0,4,135);
		if(G1){
			Pm(5,0,1,135,650,11,1,5,230,0,0);
			TD(-20,400,11,250,0,71,0);
		}
		else{
			Pm(5,0,1,135,600,11,0,0,300,0,0);
			TD(-20,300,11,200,0,71,0);
		}
	}
	else{
		if(G1){
			Pm(0,0,0,165,650,01,0,0,150,0,0);

			turn(1,100,11,20,0,0);
			FCC(2,0,4,135);

			Pm(5,0,1,135,650,11,1,5,230,0,0);
			TD(-20,400,11,250,0,71,0);
		}
		else TD(0,500,01,500,0,97,0);
	}
	HM(0,300,11,50,0,0);
	FCC(1,2,1,165);
	
	if(G1){
		turn(-1,100,11,20,0,0);
		HM(20,600,10,300,0,0);
		HM(20,600,01,0,-300,100);
		turn(1,100,11,20,0,0);
	}
	else{
		TD(0,500,11,450,0,92,0);
		FCC(2,0,8,135);
		Pm(0,0,1,135,600,10,0,0,250,0,0);
		TD(0,500,01,500,0,-92,0);
	}
	attack3(1);
	
	LM(4,400,100,11,-100,150,-92,0);
	
	FCC(2,0,1,165);
	Pm(0,0,0,165,650,10,0,0,400,0,0);
	Pm(0,0,1,135,650,00,0,0,250,0,0);
	TD(0,500,01,500,0,92,0);
	HM(0,300,11,50,0,0);

	FCC(1,0,4,230);
	FCC(2,0,1,165);
	Pm(0,0,0,165,650,10,0,0,350,0,0);
	TD(0,500,01,500,0,92,0);
	HM(0,300,11,50,0,0);
	
	FCC(1,2,1,165);

	TD(0,500,11,500,0,92,0);
	
	if(psd_value[5]<100) A=1;
	else if(psd_value[3]<100) A=2;
	else A=3;

	ping(1);
	attack3(1);
	LM(1,400,100,11,5,100,-71,0);
	FCC(2,0,4,135);
	Pm(5,0,1,135,600,11,1,5,230,0,0);
	turn(-1,100,11,20,0,0);	
	FCC(1,2,1,165);
}
void M2()
{
	if(debug){
		//T=2;
		A=2;
	}

	FCC(1,2,1,165);
	if(A==1){
		TD(0,500,11,450,-10,-92,0);

		FCC(2,2,0,0);
		TD(0,450,11,450,0,45,0);
		TD(-45,400,11,100,300,-45,0);
		FCC(2,0,1,165);
	}
	else if(A==2){
		Pm(0,0,0,165,650,10,0,0,250,0,0);
		TD(0,500,01,500,0,-92,0);

		FCC(2,2,0,0);
		Pm(0,2,2,150,600,10,0,0,550,0,0);
	}
	else if(A==3){
		Pm(0,0,0,165,650,10,0,0,550,0,0);
		TD(0,500,01,500,0,-92,0);

		FCC(2,2,0,0);
		TD(0,450,11,450,0,-45,0);
		TD(45,400,11,70,-300,45,0);
		FCC(2,0,1,165);
	}
	Pm(0,0,0,165,600,01,0,0,450,0,60);
	Pm(0,0,0,165,100,11,1,0,110,0,0);
	attack3(0);
	turn(-1,100,11,20,0,0);
	FCC(2,0,3,135);
	Pm(4,2,2,150,600,11,0,0,500,0,0);
	
	if(A==3){
		HM(20,500,11,-20,150,0);
		turn(-1,200,11,50,0,0);

		Pm(5,2,2,150,600,11,1,5,230,0,0);
	}
	else{
		HM(20,500,11,0,150,0);
		turn(-1,200,11,50,0,0);
		
		FCC(2,0,4,135);
		Pm(5,0,1,135,600,11,1,5,230,0,0);
	}
	turn(-1,100,11,20,0,0);
	FCC(1,2,1,165);
}
void M3()
{
	if(debug) T=2;

	FCC(1,2,1,165);
	TD(0,400,11,250,0,92,0);

	ping(1);
	Pm(0,2,2,150,500,10,0,0,100,0,0);
	Pm(0,0,0,165,500,00,1,0,60,0,0);
	TD(0,400,01,300,0,92,0);
	HM(0,300,11,50,0,0);
	FCC(1,2,3,230);

	TD(0,300,11,200,-50,-90,0);
	FCC(1,1,0,0);
	FCC(2,0,8,135);

	Pm(0,0,1,135,650,11,0,0,1400-px[1],0,0);
	V1(0,0,0,0,0,180,0,240,130,90,1);
	FCC(2,0,8,135);
	attack2(0);

	turn(-1,100,11,20,0,0);
	FCC(2,0,5,165);
	Pm(4,0,0,165,600,11,0,0,400,0,0);
	TD(20,300,11,200,0,-71,0);
	HM(0,300,11,50,0,0);
	FCC(1,2,8,135);
}
void M4()
{
	FCC(1,2,8,135);
	TD(0,400,11,350,0,92,0);
	HM(0,500,11,200,-150,0);
	attack2(1);
	Hm(180,400,11,0,0,1,4,230,0,0);
	HM(0,300,11,-50,0,0);

	FCC(2,0,8,135);
	turn(-1,200,11,90,0,0);
	FCC(2,0,1,130);

	Pm(0,0,0,130,500,10,0,0,250,0,0);
	TD(0,400,01,350,50,92,0);
	attack2(1);
	
	FCC(2,0,8,135);
	HM(0,500,11,0,150,0);
	FCC(1,2,0,0);

	turn(-1,200,11,90,0,0);
	HM(0,500,11,350,-100,0);
	TD(0,400,11,300,10,92,0);
	FCC(1,0,0,0);

	ping(1);
	FCC(2,0,1,165);
	Pm(0,0,0,165,600,11,0,0,200,0,0);
	attack2(0);
	turn(-1,100,11,20,0,0);
	FCC(2,0,3,135);
	
	Pm(4,0,1,135,600,11,1,4,230,0,0);
	HM(20,300,11,-50,0,0);
	LM(1,400,0,11,0,350,-92,0);

	HM(0,500,11,-150,100,0);

	turn(-1,200,11,70,0,0);
	TD(-20,400,11,150,200,-22,0);
	FCC(2,0,1,165);

	ping(1);
	Pm(0,0,0,165,500,10,1,0,60,0,0);
	TD(0,400,01,300,0,92,0);

	HM(0,300,11,50,0,0);
	FCC(1,2,3,230);

	TD(0,300,11,200,-50,-90,0);
	FCC(1,1,0,0);
	FCC(2,0,8,135);

	int len=1170-px[1];
	if(len>=600){
		Pm(0,0,1,135,500,10,0,0,len-500,0,0);
		TD(0,500,01,500,0,-92,0);
	}
	else TD(0,500,11,len,0,-92,0);
	HM(0,300,11,50,0,0);
	FCC(1,2,8,135);
}
void M5()
{
	if(debug){
		A=1;
		G1=1;
	}

	FCC(1,2,8,135);
	if(A==1){
		TD(0,500,11,450,0,92,0);
	}
	else{
		Pm(0,0,1,135,650,10,0,0,300*(A-1)-50,0,0);
		TD(0,500,01,500,0,92,0);
	}
	FCC(2,2,0,0);

	set(!G1);

	TD(0,500,11,500,0,92*rev_stdir,0);
	int a=dir?4-A:A;
	if(a==1){
		FCC(2,2,0,0);
		TD(0,500,11,500,0,92*stdir,0);
	}
	else{
		Pm(0,2,2,150,600,10,0,0,100,0,0);
		Pm(0,0,rev_dir,rev_ta,600,00,0,0,300*(a-1)-100,0,0);
		TD(0,500,01,500,0,92*stdir,0);
	}
	HM(0,300,11,50,0,0);
	FCC(1,2,rev_num,rev_ta);
}
void M6()
{
	if(debug){
		G1=1;
	}
	set(!G1);
	FCC(1,2,rev_num,rev_ta);
	Pm(0,0,rev_dir,rev_ta,650,10,0,0,350,0,0);
	TD(0,500,01,500,0,40*stdir,0);
	TD(40*rev_stdir,400,11,50,300*stdir,40*rev_stdir,0);
	FCC(2,2,0,0);

	TD(0,500,11,450,0,71,0);
	FCC(2,0,3,135);
	Pm(4,0,1,135,650,11,1,4,230,0,0);
	HM(20,300,11,-30,0,0);
}
void M7()
{
	
}
void M8()
{
	
}
void M9()
{

}

int main(void){
	unsigned char M_cnt=0;
    Interface_init();

	while(1)
	{
		if(SW1)
		{
			M_cnt++;
			PORTB=1;
			while(SW1);
			PORTB=0;
		}
		if(SW2)
		{
			M_cnt--;
			PORTB=2;
			while(SW2);
			PORTB=0;
		}
		if(SW3)
		{
			cls();
			WriteCommand(0,DFH);
			WriteCommand(1,DFH);
			WriteCommand(2,DFH);
			ping(0);
			debug=1;
			if(!M_cnt)
			{
				debug=0;
				M1(); M2(); M3(); M4(); M5(); M6(); M7(); M8(); M9();
				StopMotion(9);
				
				PORTB|=0x0F;
				_delay_ms(2000);
				PORTB&=~0x0F;
			}
			else if(M_cnt==1) M1();
			else if(M_cnt==2) M2();
			else if(M_cnt==3) M3();
			else if(M_cnt==4) M4();
			else if(M_cnt==5) M5();
			else if(M_cnt==6) M6();
			else if(M_cnt==7) M7();
			else if(M_cnt==8) M8();
			else if(M_cnt==9) M9();
			StopMotion(9);
		}
		if(SW4)
		{
			cls();
			WriteCommand(0,DFH);
			WriteCommand(1,DFH);
			WriteCommand(2,DFH);
			ping(0);

			Buzz(3);
			PORTB=1;
			while(SW4)
			{
				if(SW1) cls(), PORTB=1;
				if(SW2) cls(), PORTB=2;
				if(SW3) cls(), PORTB=4;

				if(PORTB&1)
				{	
					ping(0);
					sprintf(str,"    X = (%5d)",(int)px[0]); lcd_display_str(1,0,str);
					sprintf(str,"    Y = (%5d)",(int)py[0]); lcd_display_str(2,0,str);
					sprintf(str,"    W = (%5d)",(int)pw[0]); lcd_display_str(3,0,str);
				}
				if(PORTB&2)
				{
					dc(0,9,psd_value[0]);
					dc(0,4,psd_value[1]);dc(0,14,psd_value[8]);
					dc(1,0,psd_value[2]);dc(1,17,psd_value[7]);
					dc(2,0,psd_value[3]);dc(2,17,psd_value[6]);
					dc(3,4,psd_value[4]);dc(3,14,psd_value[5]);
				}
				if(PORTB&4)
				{
					V1(11,0,0,0,0,180,0,240,0,0,0);
					
					for(int i=0;i<5;i++){
						dc(0,i*4,C_D[i][0]);
						dc(1,i*4,C_D[i][1]);
						dc(2,i*4,C_D[i][2]);
					}

					dc(3,17,C_N);
				}
			}
			PORTB=0;
			cls();
		}
		dc(3,17,M_cnt);
	}
}



